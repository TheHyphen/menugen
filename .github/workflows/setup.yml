name: Cloudflare Setup

on:
  workflow_dispatch:
    inputs:
      jwt_secret:
        description: "JWT secret for auth tokens (leave blank to auto-generate)"
        required: false
        type: string

jobs:
  setup:
    name: Initialize Cloudflare Infrastructure
    runs-on: ubuntu-latest
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - run: pnpm install --frozen-lockfile

      # ── Step 1: Create D1 database ──────────────────────────────────
      - name: Create D1 database
        id: create_db
        working-directory: packages/backend
        run: |
          # List existing databases — wrangler may print non-JSON lines before the array,
          # so we strip everything up to the first '[' before feeding it to jq.
          RAW=$(npx wrangler d1 list 2>/dev/null || true)
          echo "--- wrangler d1 list output ---"
          echo "$RAW"
          echo "-------------------------------"

          # Try to extract UUID for our database. Handles both --json and plain text.
          EXISTING=""
          # Attempt JSON parse: grab from first '[' to end, then query with jq
          JSON_PART=$(echo "$RAW" | sed -n '/^\[/,$ p')
          if [ -n "$JSON_PART" ]; then
            EXISTING=$(echo "$JSON_PART" | jq -r '.[] | select(.name=="menugen-db") | .uuid' 2>/dev/null || true)
          fi
          # Fallback: plain-text grep for a UUID on the same line as menugen-db
          if [ -z "$EXISTING" ] || [ "$EXISTING" = "null" ]; then
            EXISTING=$(echo "$RAW" | grep 'menugen-db' | grep -oP '[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}' | head -1 || true)
          fi

          if [ -n "$EXISTING" ] && [ "$EXISTING" != "null" ]; then
            echo "Database already exists with ID: $EXISTING"
            echo "db_id=$EXISTING" >> "$GITHUB_OUTPUT"
            echo "created=false" >> "$GITHUB_OUTPUT"
          else
            echo "Creating D1 database..."
            OUTPUT=$(npx wrangler d1 create menugen-db 2>&1)
            echo "$OUTPUT"
            # Try multiple patterns to extract the database ID
            DB_ID=$(echo "$OUTPUT" | grep -oP 'database_id\s*=\s*"\K[^"]+' || true)
            if [ -z "$DB_ID" ]; then
              DB_ID=$(echo "$OUTPUT" | grep -oP '"uuid"\s*:\s*"\K[^"]+' || true)
            fi
            if [ -z "$DB_ID" ]; then
              DB_ID=$(echo "$OUTPUT" | grep -oP '[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}' | head -1 || true)
            fi
            if [ -z "$DB_ID" ]; then
              echo "::error::Failed to extract database ID from wrangler output"
              exit 1
            fi
            echo "Created database with ID: $DB_ID"
            echo "db_id=$DB_ID" >> "$GITHUB_OUTPUT"
            echo "created=true" >> "$GITHUB_OUTPUT"
          fi

      # ── Step 2: Update wrangler.toml with real database ID ──────────
      - name: Update wrangler.toml with database ID
        working-directory: packages/backend
        run: |
          sed -i 's/database_id = ".*"/database_id = "${{ steps.create_db.outputs.db_id }}"/' wrangler.toml
          echo "Updated wrangler.toml:"
          cat wrangler.toml

      # ── Step 3: Set JWT secret ──────────────────────────────────────
      - name: Configure JWT secret
        working-directory: packages/backend
        run: |
          if [ -n "${{ inputs.jwt_secret }}" ]; then
            JWT="${{ inputs.jwt_secret }}"
          else
            JWT=$(openssl rand -hex 32)
            echo "Auto-generated JWT secret"
          fi
          sed -i "s/JWT_SECRET = \".*\"/JWT_SECRET = \"$JWT\"/" wrangler.toml

      # ── Step 4: Run D1 migrations ───────────────────────────────────
      - name: Run D1 migrations
        working-directory: packages/backend
        run: |
          npx wrangler d1 execute menugen-db --remote --file=./migrations/0001_init.sql
          echo "Migrations applied successfully"

      # ── Step 5: Deploy backend worker ───────────────────────────────
      - name: Deploy backend worker
        working-directory: packages/backend
        id: deploy_worker
        run: |
          OUTPUT=$(npx wrangler deploy 2>&1)
          echo "$OUTPUT"
          # Extract the worker URL from deployment output
          WORKER_URL=$(echo "$OUTPUT" | grep -oP 'https://[^\s]+\.workers\.dev' | head -1 || true)
          echo "worker_url=$WORKER_URL" >> "$GITHUB_OUTPUT"
          echo "Worker deployed at: $WORKER_URL"

      # ── Step 6: Create Pages project & deploy frontend ──────────────
      - name: Build frontend
        run: pnpm build:frontend
        env:
          VITE_API_URL: ${{ steps.deploy_worker.outputs.worker_url }}

      - name: Deploy frontend to Cloudflare Pages
        id: deploy_pages
        run: |
          # Create pages project if it doesn't exist (wrangler pages deploy handles this)
          OUTPUT=$(npx wrangler pages deploy packages/frontend/dist --project-name=menugen 2>&1) || true
          echo "$OUTPUT"
          PAGES_URL=$(echo "$OUTPUT" | grep -oP 'https://[^\s]+\.pages\.dev' | head -1 || true)
          echo "pages_url=$PAGES_URL" >> "$GITHUB_OUTPUT"

      # ── Step 7: Commit wrangler.toml with real database ID ──────────
      - name: Commit updated wrangler.toml
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # Only commit the database_id change, not the JWT secret
          # Re-read and set only the database_id, keep JWT as placeholder in repo
          sed -i 's/JWT_SECRET = ".*"/JWT_SECRET = "change-me-in-production"/' packages/backend/wrangler.toml
          git add packages/backend/wrangler.toml
          git diff --cached --quiet && echo "No changes to commit" || \
            git commit -m "chore: update D1 database_id after Cloudflare setup" && \
            git push

      # ── Summary ─────────────────────────────────────────────────────
      - name: Print summary
        run: |
          echo "## Cloudflare Setup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| D1 Database ID | \`${{ steps.create_db.outputs.db_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| D1 Database Created | ${{ steps.create_db.outputs.created }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Worker URL | ${{ steps.deploy_worker.outputs.worker_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Pages URL | ${{ steps.deploy_pages.outputs.pages_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Set \`VITE_API_URL\` repository variable to your Worker URL: \`${{ steps.deploy_worker.outputs.worker_url }}\`" >> $GITHUB_STEP_SUMMARY
          echo "2. The JWT secret was deployed to the worker but kept out of the repo for security" >> $GITHUB_STEP_SUMMARY
          echo "3. Future deploys will use the \`Deploy\` workflow automatically on push to main" >> $GITHUB_STEP_SUMMARY
